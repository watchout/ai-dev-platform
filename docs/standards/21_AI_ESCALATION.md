# 21_AI_ESCALATION.md - AI 中断・質問プロトコル

> AIが独断で進めず、疑問点を即座にユーザーに確認する体制

---

## 基本原則

```
AIは「わからないこと」を推測して進めてはならない。

推測で進めた場合のコスト:
  AIが勝手に決定 → 実装完了 → レビューで発覚 → 手戻り
  = 数時間〜数日のロス

即座に質問した場合のコスト:
  AIが中断 → 質問 → 回答（1分）→ SSOT更新 → 正確な実装
  = 1分のロス

結論: 1%でも不明な点があれば、即座に中断して質問する
```

---

## 中断トリガー（AIが中断すべき状況）

### 7つの中断トリガー

```
以下のいずれかに該当したら、AIは即座に作業を中断し、
ユーザーに質問する。

T1: SSOT に記載がない仕様判断
────────────────────────────────
  「この場合どう動くべきか」がSSOTに書かれていない。

  例: 「同時に2つのファイルをアップロードした場合の動作」
      がSSOTに定義されていない。
  → 中断して質問

T2: SSOT の記載が曖昧
────────────────────────────────
  SSOTに記載はあるが、複数の解釈が可能。

  例: 「適切なエラーメッセージを表示する」
      → 何が「適切」かが不明
  → 中断して質問

T3: 技術的な選択肢が複数ある
────────────────────────────────
  実装方法が複数あり、どれを選ぶべきか判断できない。

  例: リアルタイム更新を
      a) WebSocket で実装
      b) Server-Sent Events で実装
      c) ポーリングで実装
      → どれがこのプロジェクトに適切か不明
  → 中断して質問

T4: SSOTと既存実装の矛盾
────────────────────────────────
  SSOTの定義と、既存のコードが矛盾している。

  例: SSOTでは「論理削除」と定義されているが、
      既存の別機能では「物理削除」で実装されている。
  → 中断して質問（SSOTが正か、既存実装が正か）

T5: 制約・規約に未定義のケース
────────────────────────────────
  コーディング規約やアーキテクチャ制約に記載のない
  パターンに遭遇した。

  例: 規約では「Service層からRepositoryを呼ぶ」だが、
      今回は外部APIも呼ぶ必要がある。
      Service → ExternalAPI の位置づけが未定義。
  → 中断して質問

T6: 影響範囲が不明
────────────────────────────────
  この変更が他の機能にどう影響するか判断できない。

  例: DBスキーマを変更したいが、
      他の機能がこのテーブルを参照しているか不明。
  → 中断して質問

T7: ビジネス判断が必要
────────────────────────────────
  技術的にはどちらでも実装できるが、
  ビジネス要件としてどうすべきかわからない。

  例: 無料プランの制限を超えた場合、
      a) 機能をブロックする
      b) 警告を出して続行を許可する
      → ビジネス判断
  → 中断して質問
```

---

## 中断時の行動プロトコル

### ステップ1: 即座に中断

```
AIは以下のフォーマットで中断を通知する:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 作業を中断します（確認が必要です）

トリガー: [T1〜T7のどれか]
発生箇所: [何をしている時に発生したか]

質問:
[具体的な質問]

選択肢（あれば）:
a) [選択肢A] → [その場合の影響]
b) [選択肢B] → [その場合の影響]
c) [選択肢C] → [その場合の影響]

推奨: [AIの推奨があれば]
推奨の根拠: [なぜその推奨か]

影響範囲:
[この決定が影響する他の機能・ドキュメント]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### ステップ2: ユーザーの回答を待つ

```
AIはユーザーの回答が得られるまで:
- 該当タスクの作業を停止する
- 推測で進めない
- 「とりあえず仮で進める」をしない
- 影響を受けない別のタスクがあれば、そちらを先に進めてよい
```

### ステップ3: 回答に基づくSSO/プロンプト更新

```
ユーザーの回答を得たら:

1. 回答をSSOTの該当セクションに反映
   → 「§7 ビジネスルール BR-012 を追加」等

2. 更新したSSOTのセクションをユーザーに確認
   「SSOTを以下のように更新しました:
    [更新内容]
    この内容で正しいですか？」

3. ユーザーの確認を得てから作業を再開

4. プロンプトにも反映が必要な場合はプロンプトも更新
```

---

## 各フェーズでの中断ルール

### プロンプト作成時

```
プロンプトを書いている時に中断すべきケース:

- SSOTの参照セクションに曖昧な記述がある
  → T2: 中断して明確化を求める
  → 明確化した内容でSSOTを更新してからプロンプトに反映

- 実装順序が不明
  → T3: 中断して確認
  → 例:「バリデーションをフロント側かサーバー側か、
        どちらで先に実装しますか？」

- SSOTにない要件を書こうとしている
  → T1: 中断して確認
  → 例:「プロンプトに書くべきエッジケースが
        SSOTに定義されていません。追加しますか？」
```

### 実装時

```
コードを書いている時に中断すべきケース:

- SSOTのビジネスルールが特定のケースをカバーしていない
  → T1: 中断して質問
  → 例:「入力が空文字の場合の動作がSSOTに
        定義されていません。どうしますか？」

- 技術的に複数のアプローチがある
  → T3: 中断して質問
  → 例:「この処理、同期と非同期どちらで実装しますか？
        a) 同期: シンプルだがUIが3秒ブロックされる
        b) 非同期: UIは即応答だが実装が複雑」

- 既存コードとの矛盾を発見
  → T4: 中断して質問
  → 例:「SSOTでは日時をUTCで保存と定義されていますが、
        既存のusersテーブルではJSTで保存されています。
        どちらに統一しますか？」
```

### 修正時

```
コードを修正している時に中断すべきケース:

- 修正の影響範囲が判断できない
  → T6: 中断して質問
  → 例:「この修正でAPIのレスポンス型が変わります。
        フロントの[画面名]にも影響しますが、
        そちらも同時に修正しますか？」

- 修正がSSOTの変更を必要とする
  → T4: 中断して質問
  → 例:「バグ修正のためにSSOTの§7 BR-005を
        変更する必要があります。承認しますか？
        変更内容: [具体的な変更]」
```

### テスト時

```
テストを書いている/実行している時に中断すべきケース:

- SSOTのテストケースでカバーされていないケースを発見
  → T1: 中断して質問
  → 例:「テスト中に、SSOTに定義されていないエッジケースを
        発見しました。[具体的なケース]
        テストを追加しSSOTにも反映しますか？」

- テストが失敗し、SSOTとコードのどちらが正しいか不明
  → T4: 中断して質問
  → 例:「テストが失敗しています。
        SSOTの定義: [定義内容]
        実際の動作: [実際の動作]
        SSOTが正しいですか？それとも実装が正しいですか？」
```

---

## SSOT更新フロー

```
質問発生
    │
    ▼
ユーザー回答
    │
    ▼
回答がSSOTの変更を必要とするか？
    │
    ├── No → 回答を実装に直接反映 → 作業再開
    │
    └── Yes
        │
        ▼
    SSOT更新案を作成
        │
        ▼
    ユーザーに更新内容を確認
    「SSOTの§X を以下のように更新します:
     [変更前] → [変更後]
     よろしいですか？」
        │
        ├── OK → SSOT更新 → 作業再開
        └── 修正 → 修正案を再提示 → 確認
```

### SSOT更新記録

```
SSOTを更新した場合、§1 変更履歴に記録する:

| バージョン | 日付 | 変更内容 | 理由 | 変更者 |
|-----------|------|---------|------|-------|
| 1.1 | YYYY-MM-DD | §7 BR-012 追加: 空文字入力時のエラー | 実装時にT1トリガーで発覚 | AI + ユーザー |
```

---

## Claude Code / Cursor への組み込み

### CLAUDE.md に追加するルール

```markdown
## AI中断プロトコル（必須）

以下の場合、即座に作業を中断しユーザーに質問してください:

1. SSOTに記載がない仕様判断が必要な時
2. SSOTの記載が曖昧で複数解釈が可能な時
3. 技術的な選択肢が複数あり判断できない時
4. SSOTと既存実装が矛盾している時
5. 制約・規約に未定義のケースに遭遇した時
6. 変更の影響範囲が判断できない時
7. ビジネス判断が必要な時

中断時のフォーマット:
⚠️ 確認が必要です
トリガー: [T1-T7]
質問: [具体的な質問]
選択肢: [あれば]
推奨: [あれば]

「推測で進める」「とりあえず仮で」は禁止です。
1%でも不明な点があれば質問してください。
```

### .cursorrules に追加するルール

```
# AI中断プロトコル
不明点がある場合は作業を中断し、ユーザーに質問すること。
推測で実装を進めることは禁止。
docs/21_AI_ESCALATION.md の7つのトリガーに該当する場合は
必ず中断して質問する。
```

---

## 禁止行動リスト

```
以下の行動は明確に禁止する:

❌ 「おそらく○○だろう」と推測して実装する
❌ 「一般的には○○なので」と勝手にデフォルトを選ぶ
❌ 「後で確認する」として仮実装で進める
❌ TODO/FIXMEコメントで不明点を後回しにする
❌ SSOTにない仕様を「良かれと思って」追加する
❌ エラーケースが不明だから握りつぶす
❌ 「些細なことだから」と判断して質問しない
❌ 複数回の質問を避けるために曖昧なまま進める
```

---

## 質問の品質基準

```
良い質問:
  「入力が空文字の場合、SSOTに定義がありません。
   a) バリデーションエラーにする（推奨: 一般的なパターン）
   b) 空文字を許可する
   どちらにしますか？」

悪い質問:
  「入力チェックどうしますか？」
  → 何が聞きたいのか不明。選択肢も推奨もない。

質問のチェックリスト:
  □ 何について聞いているか明確
  □ なぜ聞く必要があるか（トリガー）が明示
  □ 選択肢がある（可能な場合）
  □ 推奨がある（根拠付き）
  □ この決定の影響範囲が明示
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |
