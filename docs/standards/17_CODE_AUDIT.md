# 17_CODE_AUDIT.md - 実装コード品質監査

> AIが生成したコードを本番投入する前に品質を保証する

---

## なぜ実装監査が必要か

```
プロンプトが100点でも、AIの出力が100点とは限らない。

よくある問題:
- プロンプトでは禁止したのにany型が使われている
- エラーハンドリングが一部抜けている
- SSOTのMUST要件の1つが実装されていない
- コーディング規約の命名規則に違反している
- セキュリティホール（認証チェック漏れ等）

→ 実装後にコードを監査し、100点になるまで修正する
```

---

## 監査プロセス

```
  AI実装完了（コード出力）
      │
      ▼
  ① SSOT準拠チェック
     全MUST要件が実装されているか
      │
      ▼
  ② コード品質スコアリング（100点満点）
      │
      ├── 100点 → 合格 ✅ → テストへ
      ├── 90-99点 → 修正プロンプト作成 → AI修正 → 再監査
      └── 89点以下 → 問題箇所特定 → 再実装 → 再監査
      │
      ▼
  100点で合格 → テスト工程へ
```

---

## 品質スコアカード（100点満点）

```
┌─ コード品質スコアカード ──────────────────────────────────────────────┐
│                                                                        │
│  #   カテゴリ             配点   評価基準                              │
│  ──────────────────────────────────────────────────────────────────── │
│  1   SSOT準拠性           25    全MUST要件が実装されているか          │
│  2   型安全性             15    型定義の正確性・any不使用             │
│  3   エラーハンドリング   15    全エラーケースが処理されているか      │
│  4   セキュリティ         15    認証・認可・入力検証・インジェクション │
│  5   コーディング規約     10    命名・構造・フォーマット              │
│  6   保守性               10    可読性・関数分割・コメント            │
│  7   パフォーマンス       5     N+1クエリ・不要な再レンダリング等     │
│  8   完全性               5     TODO/FIXME/省略コメントがないか       │
│                                                                        │
│  合計                    100                                           │
│  合格ライン              100点（満点必須）                             │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## カテゴリ別 詳細採点基準

### 1. SSOT準拠性（25点）

```
SSOTの §3 機能要件と照合する。

チェック方法:
  SSOTの全MUST要件をリストし、
  各要件に対応するコードが存在するか1つずつ確認する。

  FR-001 [MUST]: ○○ → src/xxx.ts L42-58 ✅
  FR-002 [MUST]: ○○ → src/xxx.ts L60-85 ✅
  FR-003 [MUST]: ○○ → 該当コードなし ❌ → -5点

減点:
  MUST要件の未実装: -5点/件（致命的）
  SHOULD要件の未実装: -2点/件
  SSOTに定義されていない独自仕様の追加: -3点/件
```

### 2. 型安全性（15点）

```
チェック項目:
  - any 型が使われていないか
  - unknown + 型ガードで適切に処理しているか
  - as による型アサーションが不要に使われていないか
  - 関数の引数と戻り値に型が明示されているか
  - null/undefined の処理が適切か
  - API レスポンスの型がSSOTの §5 と一致するか

減点:
  any 使用: -3点/件
  不要な as アサーション: -2点/件
  引数/戻り値の型欠落: -2点/件
  null/undefined チェック漏れ: -2点/件
```

### 3. エラーハンドリング（15点）

```
SSOTの §9 エラーハンドリングと照合する。

チェック方法:
  §9 の全エラーケースに対して、
  対応するハンドリングコードが存在するか確認。

  入力バリデーションエラー → バリデーション処理あり ✅
  認証エラー → 認証チェックあり ✅
  外部API障害 → try-catch + フォールバック ✅
  タイムアウト → タイムアウト設定なし ❌ → -3点

減点:
  エラーケース未処理: -3点/件
  空のcatchブロック（握りつぶし）: -5点/件（致命的）
  ユーザーへのエラーメッセージ欠落: -2点/件
  エラーログ出力漏れ: -1点/件
```

### 4. セキュリティ（15点）

```
OWASP Top 10 ベースのチェック:

  認証チェック:
    - 保護されたエンドポイントに認証チェックがあるか
    - セッション管理が適切か

  認可チェック:
    - 他ユーザーのデータにアクセスできないか
    - RLS（Row Level Security）が設定されているか

  入力検証:
    - 全入力がサーバーサイドでバリデーションされているか
    - SQLインジェクション対策（パラメータバインド）
    - XSS対策（出力エスケープ）

  データ保護:
    - 機密情報がログに出力されていないか
    - 環境変数がハードコードされていないか

減点:
  認証チェック漏れ: -5点/件（致命的）
  認可チェック漏れ: -5点/件（致命的）
  入力バリデーション漏れ: -3点/件
  環境変数ハードコード: -3点/件
  機密情報のログ出力: -3点/件
```

### 5. コーディング規約（10点）

```
CODING_STANDARDS.md と照合する。

チェック項目:
  - 命名規約（camelCase / PascalCase / kebab-case）
  - ファイル構成規約（正しいディレクトリ配置）
  - インポート順序
  - 1ファイルの行数上限
  - 関数の行数上限
  - コメント規約

減点:
  命名規約違反: -1点/件（最大-5点）
  ファイル配置違反: -2点/件
  行数上限超過: -2点/件
```

### 6. 保守性（10点）

```
チェック項目:
  - 1関数1責務（Single Responsibility）
  - 関数が短い（30行以内が目安）
  - マジックナンバーがない（定数化されている）
  - 公開関数にJSDoc/コメントがある
  - ネストが深すぎない（3階層以内）
  - 重複コードがない（DRY原則）

減点:
  1関数100行超: -3点/件
  マジックナンバー: -1点/件
  重複コード: -2点/件
  ネスト4階層以上: -2点/件
```

### 7. パフォーマンス（5点）

```
チェック項目:
  - N+1クエリがないか
  - 不要な再レンダリングがないか（React）
  - 大量データのメモリ展開がないか
  - 不要なAPI呼び出しがないか
  - インデックスが適切に使われるクエリか

減点:
  N+1クエリ: -3点/件
  不要な全件取得: -2点/件
```

### 8. 完全性（5点）

```
チェック項目:
  - TODO コメントが残っていないか
  - FIXME コメントが残っていないか
  - // ... 省略 が残っていないか
  - console.log がプロダクションコードに残っていないか
  - デバッグ用コードが残っていないか
  - 未使用の import がないか

減点:
  TODO/FIXME残存: -2点/件
  省略コメント残存: -3点/件（致命的）
  console.log残存: -1点/件
  未使用import: -1点/件
```

---

## 監査レポートテンプレート

```markdown
# コード品質監査レポート

## 対象
| 項目 | 内容 |
|------|------|
| タスクID | [FEAT-XXX-LAYER] |
| 対象ファイル | [ファイル一覧] |
| 監査日 | [YYYY-MM-DD] |
| 監査回数 | [初回 / 第2回 / ...] |

## SSOT準拠チェック

| 要件ID | レベル | 要件 | 実装箇所 | 結果 |
|--------|--------|------|---------|------|
| FR-001 | MUST | [要件] | src/xxx L42-58 | ✅ / ❌ |
| FR-002 | MUST | [要件] | src/xxx L60-85 | ✅ / ❌ |

## スコア

| # | カテゴリ | 配点 | 得点 | 減点理由 |
|---|---------|------|------|---------|
| 1 | SSOT準拠性 | 25 | /25 | |
| 2 | 型安全性 | 15 | /15 | |
| 3 | エラーハンドリング | 15 | /15 | |
| 4 | セキュリティ | 15 | /15 | |
| 5 | コーディング規約 | 10 | /10 | |
| 6 | 保守性 | 10 | /10 | |
| 7 | パフォーマンス | 5 | /5 | |
| 8 | 完全性 | 5 | /5 | |
| **合計** | | **100** | **/100** | |

## 判定
- ✅ 合格: 100点
- ⚠️ 修正要: 90-99点
- ❌ 大幅修正: 89点以下

## 指摘事項

| # | 重大度 | カテゴリ | ファイル:行 | 指摘内容 | 修正案 |
|---|--------|---------|-----------|---------|-------|
| 1 | | | | | |

## 修正プロンプト（修正が必要な場合）
以下の指摘を修正してください:
[指摘事項を含んだ修正プロンプト]
```

---

## AIへの監査実行指示

```
以下のコードを 17_CODE_AUDIT.md に従って監査してください。

対象コード:
[コード全文をペースト]

SSOT:
[該当SSOTの §3, §5, §7, §9 をペースト]

コーディング規約:
[CODING_STANDARDS.md をペースト]

8カテゴリ・100点満点でスコアリングし、
100点未満の場合は具体的な修正プロンプトを生成してください。
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |
